(function(angular){'use strict';spApp.service('searchService',['$http',function($http){var facets='',selectedFacets={};return{getSearchResults:function(searchPhrase,resultStart,limit,searchQuery,searchSubs,selectedFacets,urlSuffix){return $http.get("/api.search"+urlSuffix+".php?"+"searchPhrase="+searchPhrase+"&limit="+limit+"&resultStart="+resultStart+"&cleanSearch=0"+"&searchQuery="+searchQuery+"&selectedFacets="+selectedFacets+"&searchSubs="+searchSubs).then(function(response){return response.data;})}}}]);spApp.controller('searchField',['$scope','searchService',function($scope,searchService){$scope.init=function(){if(typeof(searchPhraseURL)!=='undefined'&&searchPhraseURL!==''){$scope.searchPhrase=searchPhraseURL;}}}]);spApp.controller('searchResults',['$scope','$http','$compile','searchService','mediaDetailsService',function($scope,$http,$compile,searchService,mediaDetailsService){$scope.$on('ngRepeatFinished',function(ngRepeatFinishedEvent){$('.flex-images.id-'+$scope.resultSectionNo).flexImages({truncate:true});addToLightboxButtonInit();$scope.resultSectionNo++;});$scope.selectedFacetCountByField=function(field){return $scope.selectedFacets[field].length;}
$scope.clearSelectedFacets=function(){if($scope.hasFacetSelected().pass){$scope.loadingHideFacets=true;$scope.resetSearch();$scope.initSearch("{}",true);}}
$scope.toggleFacet=function(field,bucket,options){if(typeof options!=='undefined'&&options!==''){options=JSON.parse(options);}else{options={radio:false};}
var index=$scope.selectedFacets[field].indexOf(bucket.value);if(options.radio){$scope.selectedFacets[field]=[];for(var i=0;i<$scope.facets[field].buckets.length;i++){$scope.facets[field].buckets[i].selected=false;}}
if(index<0){bucket.selected=true;$scope.selectedFacets[field].push(bucket.value);}else{bucket.selected=false;$scope.selectedFacets[field].splice(index,1);}
$scope.resetSearch();$scope.initSearch($scope.hasFacetSelected().facets);}
$scope.hasFacetSelected=function(){var obj={pass:false,facets:"{}"};if(Object.keys($scope.selectedFacets).length){Object.keys($scope.selectedFacets).forEach(function(key,index){if($scope.selectedFacets[key].length){obj.pass=true;obj.facets=JSON.stringify($scope.selectedFacets);}});}
return obj;}
$scope.initFacets=function(facets){try{var hasFacets=Object.keys(facets).length>0&&JSON.stringify(facets)!==JSON.stringify({});if(hasFacets){$scope.facets=facets;Object.keys(facets).forEach(function(key,index){$scope.selectedFacets[key]=[];});}else{$scope.facets='';}}catch(e){}}
$scope.resetSearch=function(){$scope.loading=true;$scope.resultsStart=0;$scope.resultSectionNo=0;$scope.searchResults=[];}
$scope.initSearch=function(facets,clearSelectedFacets){if(searchPhraseURL!==''){searchService.getSearchResults(searchPhraseURL,$scope.resultsStart,$scope.resultsLimit,searchQueryURL,searchSubsURL,facets,$scope.urlSuffix).then(function(response){if(!$scope.hasFacetSelected().pass||clearSelectedFacets){$scope.initFacets(response.facets);}
if(!$scope.resultSectionNo){$scope.searchResults=[response.results];}else{$scope.searchResults.push(response.results);}
$scope.loading=false;$scope.loadingHideFacets=false;});}}
$scope.submitSearch=function(){var submitUrlPrefix='/search.php?q=';if($scope.urlSuffix!==".dp"){submitUrlPrefix='/editorschoice/';}
var submitUrlSuffix='';if(utils.isUrl($scope.searchPhrase)){submitUrlSuffix=encodeURIComponent($scope.searchPhrase);}else{submitUrlSuffix=$scope.searchPhrase.replace(/\s+/g,'+')}
window.location.href=submitUrlPrefix+submitUrlSuffix;}
$scope.init=function(){$scope.urlSuffix=(window.location.pathname.indexOf('editorschoice')>0?"":".dp");if(typeof(searchPhraseURL)!=='undefined'&&searchPhraseURL!==''){$scope.searchPhrase=searchPhraseURL;}
$scope.loadingHideFacets=true;$scope.resetSearch();$scope.resultsLimit=150;$scope.facets='';$scope.selectedFacets={};$scope.modalContent={url:'',html:''};$scope.selectedIndex={resultsIndex:'',itemIndex:''};console.log('initSearch');$scope.initSearch($scope.hasFacetSelected().facets);$(window).scroll(function(){if($(window).scrollTop()+$(window).height()==$(document).height()){$scope.loading=true;$scope.loadingHideFacets=false;$scope.resultsStart=$scope.resultsStart+$scope.resultsLimit;$scope.initSearch($scope.hasFacetSelected().facets);}});};$scope.viewMediaDetails=function($event,resultsIndex,itemIndex){if($event.shiftKey||$event.ctrlKey){return false;}
$event.preventDefault();$scope.modalContent.url=$event.currentTarget.href;var strsafe=$event.currentTarget.href;$scope.modalContent.Safeurl=strsafe.replace("/photo/","/photo-safe/");;$scope.selectedIndex={resultsIndex:resultsIndex,itemIndex:itemIndex};$scope.searchResults[$scope.selectedIndex.resultsIndex][$scope.selectedIndex.itemIndex]["loading"]=true;$http({method:'GET',url:$scope.modalContent.url}).success(function(data){var mediaDetails=$(data).filter('#panel').find('[ng-controller="mediaDetails"]'),mediaDetailsHtml=mediaDetails.html();$scope.modalContent.html=mediaDetailsHtml;});}
$scope.closeMediaDetails=function(){var grid=$('.media-details .flex-images');grid.each(function(){$(window).off('resize.flexImages'+$(this).data('flex-t'));});$scope.modalContent.html='';$('body').removeClass("noscroll");closeWorkbox()}
$scope.addToCart=function($event){mediaDetailsService.addToCart($event);}
$scope.reDownload=function($event){mediaDetailsService.reDownload($event);}
$scope.instantDownloadSub=function($event){mediaDetailsService.instantDownloadSub($event);}
$scope.modalInit=function(){mediaDetailsService.init();var grid=$('.media-details .flex-images .item a');grid.each(function(){$(this).attr("target","_blank");});$('body').addClass("noscroll");$scope.searchResults[$scope.selectedIndex.resultsIndex][$scope.selectedIndex.itemIndex]["loading"]=false;$(document).ready(function(){mediaDetailsService.processKeys();addToLightboxButtonInit();});}
$scope.imFinished=function(){console.log("I'm Finished! :)");}}]);spApp.directive('onFinishRender',function($timeout){return{restrict:'A',link:function(scope,element,attr){if(scope.$last===true){$timeout(function(){scope.$emit(attr.onFinishRender);});}}}}).directive('fallbackSrc',function(){var fallbackSrc={link:function postLink(scope,iElement,iAttrs){iElement.bind('error',function(){angular.element(this).attr("src",iAttrs.fallbackSrc);});}}
return fallbackSrc;}).directive('dynamic',function($compile,$timeout){return{restrict:'A',replace:true,link:function(scope,ele,attrs){scope.$watch(attrs.dynamic,function(html){ele.html(html);$compile(ele.contents())(scope);if(html){$timeout(function(){scope.modalInit();});}});}};}).directive('compileCallback',function(){return{scope:{compileCallback:"&"},link:function(scope){scope.compileCallback();}}});spApp.filter('replaceUnderscores',function(){return function(str){return str.replace("_"," ");};})})(window.angular);